``` 
WITH squad_info AS (
    SELECT
        m_s.squad_id,
        m_s.name AS squad_name,
        m_s.formation_type,
        d.name AS leader_name,
        COUNT(s_b.report_id) AS total_battles,
        SUM(
            CASE WHEN
                s_b.outcome = 'Winner'
            THEN
                1
            ELSE 
                0
            END
        ) AS victories,
        SUM(s_b.casualties) AS all_squad_casualties,
        SUM(s_b.enemy_casualties) AS all_enemy_casualties

    FROM
        MILITARY_SQUADS m_s
    LEFT JOIN
        DWARVES d ON m_s.leader_id = d.dwarf_id
    LEFT JOIN
        SQUAD_BATTLES s_b ON m_s.squad_id = s_b.squad_id

    GROUP BY 
        m_s.squad_id, m_s.name, m_s.formation_type, d.name    
),

members_stats AS (
    SELECT
        m_s.squad_id,
        SUM(
            CASE WHEN
                s_m.end_date IS NULL
            THEN
                1
            ELSE
                0
            END
        ) AS current_members,
        COUNT(DISTINCT s_m.dwarf_id) AS total_members_ever

    FROM
        MILITARY_SQUADS m_s
    LEFT JOIN
        SQUAD_MEMBERS s_m ON m_s.squad_id = s_m.squad_id
    GROUP BY
        m_s.squad_id
),

dwarf_skill_improve AS (
    SELECT
        s_m.squad_id,
        s_m.dwarf_id,
        d_s.skill_id,
        MAX(d_s.level) - MIN(d_s.level) AS skill_improvement
    FROM
        SQUAD_MEMBERS s_m
    INNER JOIN
        DWARF_SKILLS d_s ON s_m.dwarf_id = d_s.dwarf_id 
            AND d_s.date >= s_m.join_date 
            AND (d_s.date <= s_m.exit_date OR s_m.exit_date IS NULL)
    INNER JOIN
        SKILLS s ON d_s.skill_id = s.skill_id
            AND s.category = 'Combat'
    GROUP BY
        s_m.squad_id,
        s_m.dwarf_id,
        d_s.skill_id
),

squad_skills_improve AS(
    SELECT
        squad_id,
        AVG(skill_improvement) AS avg_combat_skill_improvement
    FROM
        dwarf_skill_improve
    GROUP BY
        squad_id
),

equipment_stats AS(
    SELECT
        squad_id,
        AVG(e.quality) AS avg_equipment_quality
    FROM
        SQUAD_EQUIPMENT s_e
    LEFT JOIN
        EQUIPMENT e ON s_e.equipment_id = e.equipment_id
    GROUP BY
        s_e.squad_id
),

training_stats AS (
    SELECT
        s_t.squad_id,
        COUNT(s_t.schedule_id) AS total_training_sessions,
        AVG(s_t.effectiveness) AS avg_training_effectiveness
        
    FROM
        SQUAD_TRAINING s_t
    GROUP BY
        s_t.squad_id
),

calculate_victory_per AS (
    SELECT
        s_i.squad_id,
        COALESCE(
            ROUND((s_i.victories * 100.0) / NULLIF(s_i.total_battles, 0), 2)
        , 0) AS victory_percentage
    FROM 
        squad_info s_i
)


SELECT
    s_i.squad_id,
    s_i.squad_name,
    s_i.formation_type,
    s_i.leader_name,
    s_i.total_battles,
    s_i.victories,
    c_v.victory_percentage,
    COALESCE(
        ROUND((s_i.all_squad_casualties * 100.0) / NULLIF(s_i.total_members_ever, 0), 2)
    , 0) AS casualty_rate,
    COALESCE(
        ROUND(s_i.all_enemy_casualties / NULLIF(s_i.all_squad_casualties, 0), 2)
    , 0) AS casualty_exchange_ratio,
    m_s.current_members,
    m_s.total_members_ever,
    COALESCE(
        ROUND(
            (m_s.current_members * 100) / NULLIF(m_s.total_members_ever, 0)
        , 2)
    , 0) AS retention_rate,
    e_s.avg_equipment_quality,
    t_s.total_training_sessions,
    t_s.avg_training_effectiveness,
    CORR(c_v.victory_percentage, t_s.avg_training_effectiveness) AS training_battle_correlation,
    s_s_i.avg_combat_skill_improvement,
    
    JSON_BUILD_OBJECT(
        'member_ids', (
            SELECT JSON_AGG(DISTINCT s_m.dwarf_id)
            FROM SQUAD_MEMBERS s_m
            WHERE s_i.squad_id = s_m.squad_id
        ),        
        'equipment_ids', (
            SELECT JSON_AGG(DISTINCT s_e.equipment_id)
            FROM SQUAD_EQUIPMENT s_e
            WHERE s_i.squad_id = s_e.squad_id
        ),
        'battle_report_ids', (
            SELECT JSON_AGG(DISTINCT s_b.report_id)
            FROM SQUAD_BATTLES s_b
            WHERE s_i.squad_id = s_b.squad_id
        ),
        'training_ids', (
            SELECT JSON_AGG(DISTINCT s_t.schedule_id)
            FROM SQUAD_TRAINING s_t
            WHERE s_i.squad_id = s_t.squad_id
        )
    ) AS related_entities
    
FROM
    squad_info s_i
LEFT JOIN
    members_stats m_s ON s_i.squad_id = m_s.squad_id
LEFT JOIN
    equipment_stats e_s ON s_i.squad_id = e_s.squad_id
LEFT JOIN
    training_stats t_s ON s_i.squad_id = t_s.squad_id
LEFT JOIN
    calculate_victory_per c_v ON s_i.squad_id = c_v.squad_id
LEFT JOIN
    squad_skills_improve s_s_i ON s_i.squad_id = s_s_i.squad_id
    
```


GROUP BY
    s_i.squad_id, s_i.squad_name, s_i.formation_type, s_i.leader_name, s_i.total_battles, s_i.victories, c_v.victory_percentage,
    m_s.current_members, m_s.total_members_ever, e_s.avg_equipment_quality, t_s.total_training_sessions,
    t_s.avg_training_effectiveness