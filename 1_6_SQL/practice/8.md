```
WITH trade_base AS (
    SELECT 
        c.caravan_id,
        c.fortress_id,
        f.name as fortress_name,
        c.civilization_type,
        c.arrival_date,
        EXTRACT(YEAR FROM c.arrival_date) AS year,
        EXTRACT(QUARTER FROM c.arrival_date) AS quarter,
        tt.transaction_id,
        tt.fortress_items,
        tt.caravan_items,
        tt.value,
        tt.balance_direction
    FROM 
        caravans c
    JOIN 
        trade_transactions tt ON c.caravan_id = tt.caravan_id
    JOIN 
        fortresses f ON c.fortress_id = f.fortress_id
),

fortress_civilization_stats AS (
    SELECT 
        fortress_id,
        fortress_name,
        civilization_type,
        COUNT(DISTINCT caravan_id) AS total_caravans,
        SUM(value) AS total_trade_value,
        SUM(CASE WHEN balance_direction = 'In' THEN value ELSE -value END) AS trade_balance,
        CASE 
            WHEN SUM(CASE WHEN balance_direction = 'In' THEN value ELSE -value END) > 0 
                THEN 'Favorable'
            ELSE 'Unfavorable' 
        END AS trade_relationship,
        JSON_AGG(DISTINCT caravan_id) AS caravan_ids
    FROM trade_base
    GROUP BY fortress_id, fortress_name, civilization_type
),

diplomatic_correlation AS (
    SELECT 
        fcs.fortress_id,
        fcs.civilization_type,
        COALESCE(
            COUNT(DISTINCT tb.caravan_id)::DECIMAL / 
            NULLIF(COUNT(DISTINCT de.event_id), 0),
            0
        ) AS diplomatic_correlation
    FROM fortress_civilization_stats fcs
    LEFT JOIN trade_base tb ON fcs.fortress_id = tb.fortress_id 
        AND fcs.civilization_type = tb.civilization_type
    LEFT JOIN diplomatic_events de ON fcs.civilization_type = de.civilization_type
        AND de.date BETWEEN tb.arrival_date - INTERVAL '30 days' 
                        AND tb.arrival_date + INTERVAL '30 days'
    GROUP BY fcs.fortress_id, fcs.civilization_type
),

fortress_import_dependencies AS (
    SELECT 
        c.fortress_id,
        cg.material_type,
        SUM(cg.quantity * cg.value) / COUNT(DISTINCT cg.caravan_id) AS dependency_score,
        SUM(cg.quantity) AS total_imported,
        COUNT(DISTINCT r.resource_id) AS import_diversity,
        JSON_AGG(DISTINCT r.resource_id) AS resource_ids
    FROM caravan_goods cg
    JOIN 
        caravans c ON cg.caravan_id = c.caravan_id
    JOIN 
        resources r ON cg.material_type = r.type
    GROUP BY 
        c.fortress_id, cg.material_type
    HAVING SUM(cg.quantity) > 1000
),

fortress_export_effectiveness AS (
    SELECT 
        w.fortress_id,
        w.type AS workshop_type,
        p.type AS product_type,
        ROUND((
            SUM(CASE WHEN cg.original_product_id IS NOT NULL THEN wp.quantity ELSE 0 END)::DECIMAL / 
            NULLIF(SUM(wp.quantity), 0) * 100
        ), 1) AS export_ratio,
        ROUND(AVG(NULLIF(cg.value, 0) / NULLIF(p.value, 1)), 2) AS avg_markup,
        JSON_AGG(DISTINCT w.workshop_id) AS workshop_ids
    FROM 
        workshop_products wp
    JOIN 
        workshops w ON wp.workshop_id = w.workshop_id
    JOIN 
        products p ON wp.product_id = p.product_id
    LEFT JOIN 
        caravan_goods cg ON p.product_id = cg.original_product_id
    GROUP BY 
        w.fortress_id, w.type, p.type
    HAVING SUM(wp.quantity) > 0
),

fortress_trade_timeline AS (
    SELECT 
        fortress_id,
        fortress_name,
        year,
        quarter,
        SUM(value) AS quarterly_value,
        SUM(CASE WHEN balance_direction = 'In' THEN value ELSE -value END) AS quarterly_balance,
        COUNT(DISTINCT civilization_type) AS trade_diversity
    FROM 
        trade_base
    GROUP BY 
        fortress_id, fortress_name, year, quarter
    HAVING 
        COUNT(DISTINCT caravan_id) > 0
),

fortress_summary AS (
    SELECT 
        fortress_id,
        fortress_name,
        COUNT(DISTINCT civilization_type) AS total_trading_partners,
        SUM(value) AS all_time_trade_value,
        SUM(CASE WHEN balance_direction = 'In' THEN value ELSE -value END) AS all_time_trade_balance
    FROM 
        trade_base
    GROUP BY 
        fortress_id, fortress_name
)

SELECT JSON_AGG(
    JSON_BUILD_OBJECT(
        'fortress_id', fs.fortress_id,
        'fortress_name', fs.fortress_name,
        'total_trading_partners', fs.total_trading_partners,
        'all_time_trade_value', fs.all_time_trade_value,
        'all_time_trade_balance', fs.all_time_trade_balance,
        
        'civilization_data', JSON_BUILD_OBJECT(
            'civilization_trade_data', (
                SELECT JSON_AGG(JSON_BUILD_OBJECT(
                    'civilization_type', fcs.civilization_type,
                    'total_caravans', fcs.total_caravans,
                    'total_trade_value', fcs.total_trade_value,
                    'trade_balance', fcs.trade_balance,
                    'trade_relationship', fcs.trade_relationship,
                    'diplomatic_correlation', ROUND(dc.diplomatic_correlation, 2),
                    'caravan_ids', fcs.caravan_ids
                ))
                FROM fortress_civilization_stats fcs
                LEFT JOIN diplomatic_correlation dc ON fcs.fortress_id = dc.fortress_id 
                    AND fcs.civilization_type = dc.civilization_type
                WHERE fcs.fortress_id = fs.fortress_id
            )
        ),
        
        'critical_import_dependencies', JSON_BUILD_OBJECT(
            'resource_dependency', (
                SELECT JSON_AGG(JSON_BUILD_OBJECT(
                    'material_type', material_type,
                    'dependency_score', ROUND(dependency_score, 1),
                    'total_imported', total_imported,
                    'import_diversity', import_diversity,
                    'resource_ids', resource_ids
                ))
                FROM 
                    fortress_import_dependencies fid
                WHERE 
                    fid.fortress_id = fs.fortress_id
                ORDER BY 
                    dependency_score DESC
            )
        ),
        
        'export_effectiveness', JSON_BUILD_OBJECT(
            'export_effectiveness', (
                SELECT JSON_AGG(JSON_BUILD_OBJECT(
                    'workshop_type', workshop_type,
                    'product_type', product_type,
                    'export_ratio', export_ratio,
                    'avg_markup', avg_markup,
                    'workshop_ids', workshop_ids
                ))
                FROM 
                    fortress_export_effectiveness fee
                WHERE 
                    fee.fortress_id = fs.fortress_id AND fee.export_ratio > 50
                ORDER BY 
                    export_ratio DESC
            )
        ),
        
        'trade_timeline', JSON_BUILD_OBJECT(
            'trade_growth', (
                SELECT JSON_AGG(JSON_BUILD_OBJECT(
                    'year', year,
                    'quarter', quarter,
                    'quarterly_value', quarterly_value,
                    'quarterly_balance', quarterly_balance,
                    'trade_diversity', trade_diversity
                ))
                FROM 
                    fortress_trade_timeline ftt
                WHERE 
                    ftt.fortress_id = fs.fortress_id
                ORDER BY 
                    year, quarter
            )
        )
    )
) AS all_fortresses_trade_analysis
FROM 
    fortress_summary fs;
```