
1. Получить информацию о всех гномах, которые входят в какой-либо отряд, вместе с информацией об их отрядах.

SELECT 
    d.dwarf_id, d.name, d.age, d.profession, d.squad_id, 
    s.name, s.mission 
FROM 
    Dwarves d
INNER JOIN 
    Squads s on s.squad_id = d.squad_id
WHERE 
    d.squad_id is NOT NULL;


2. Найти всех гномов с профессией "miner", которые не состоят ни в одном отряде.

SELECT 
    d.dwarf_id, d.name, d.age, d.profession, d.squad_id 
FROM 
    Dwarves d
WHERE 
    d.squad_id is NULL AND d.profession = 'Торговец';


3. Получить все задачи с наивысшим приоритетом, которые находятся в статусе "pending".

WITH 
    cte aS (SELECT MAX(priority) AS max_priority FROM Tasks)
SELECT * 
FROM 
    Tasks t 
INNER JOIN 
    cte c on c.max_priority = t.priority
WHERE 
    t.status = 'pending'

4. Для каждого гнома, который владеет хотя бы одним предметом, получить количество предметов, которыми он владеет.

SELECT 
    Dwarves.name, COUNT(Items.item_id) as item_count
FROM 
    Items INNER JOIN Dwarves on Dwarves.dwarf_id = Items.owner_id
WHERE 
    owner_id not NULL
GROUP BY 
    Items.owner_id;


5. Получить список всех отрядов и количество гномов в каждом отряде. 
Также включите в выдачу отряды без гномов.

SELECT 
    Squads.name as Название_отряда, 
    COUNT(Dwarves.name) as Количество_гномочек, 
    Dwarves.name as Имя_гнома 
FROM 
    Squads 
LEFT JOIN 
    Dwarves USING(squad_id)
GROUP By 
    Squads.name;

6. Получить список профессий с наибольшим количеством незавершённых задач ("pending" и "in_progress") у гномов этих профессий.

SELECT 
    Dwarves.profession as profession, COUNT(Tasks.task_id) as count_not_completed_task 
FROM
    Tasks
INNER JOIN 
    Dwarves 
ON
    Tasks.assigned_to = Dwarves.dwarf_id
WHERE 
    status in ('in_progress', 'pending')
GROUP BY 
	profession
ORDER BY
	count_not_completed_task DESC


7. Для каждого типа предметов узнать средний возраст гномов, владеющих этими предметами.

SELECT Items.type, ROUND(AVG(Dwarves.age), 2) FROM Items
INNER JOIN Dwarves
ON Dwarves.dwarf_id = Items.owner_id
GROUP BY Items.type

8. Найти всех гномов старше среднего возраста (по всем гномам в базе), которые не владеют никакими предметами.

WITH 
    ITEMS_WITH_OWNERS AS 
        (SELECT 
            owner_id 
        FROM 
            Items 
        WHERE 
            owner_id not NULL), 
    AVG_AGE AS 
        (SELECT 
            AVG(Dwarves.age) as avg_age 
        FROM 
            Dwarves)
SELECT * 
FROM 
    Dwarves 
CROSS JOIN 
    AVG_AGE
LEFT OUTER JOIN 
    ITEMS_WITH_OWNERS 
ON 
    Dwarves.dwarf_id = ITEMS_WITH_OWNERS.owner_id 
WHERE 
    ITEMS_WITH_OWNERS.owner_id is NULL AND Dwarves.age > AVG_AGE.avg_age;

