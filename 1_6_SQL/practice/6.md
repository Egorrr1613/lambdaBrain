```
WITH workshop_stats AS (
    SELECT 
        w.workshop_id,
        w.name AS workshop_name,
        w.type AS workshop_type,
        COUNT(DISTINCT w_c.dwarf_id) AS num_craftsdwarves,
        COALESCE(SUM(w_m.quantity), 0) AS total_used_materials,
        COALESCE(SUM(w_p.quantity), 0) AS total_quantity_produced,
        COALESCE(SUM(p.value * w_p.quantity), 0) AS total_production_value,
        AVG(p.quality) AS avg_product_quality
    FROM 
        WORKSHOPS w
    LEFT JOIN 
        WORKSHOP_MATERIALS w_m ON w_m.workshop_id = w.workshop_id
    LEFT JOIN 
        WORKSHOP_PRODUCTS w_p ON w_p.workshop_id = w.workshop_id      
    LEFT JOIN 
        PRODUCTS p ON p.product_id = w_p.product_id
    LEFT JOIN 
        WORKSHOP_CRAFTSDWARVES w_c ON w_c.workshop_id = w.workshop_id
    GROUP BY
        w.workshop_id, w.name, w.type
),

dwarf_skills AS (
    SELECT
        wc.workshop_id,
        AVG(ds.level) AS average_craftsdwarf_skill,
        CORR(p.quality, ds.level) AS skill_quality_correlation
    FROM 
        WORKSHOP_CRAFTSDWARVES wc
    JOIN 
        DWARF_SKILLS ds ON wc.dwarf_id = ds.dwarf_id
    JOIN 
        WORKSHOP_PRODUCTS wp ON wp.workshop_id = wc.workshop_id
    JOIN 
        PRODUCTS p ON p.product_id = wp.product_id
    WHERE 
        ds.skill_id IN (SELECT skill_id FROM SKILLS WHERE category = 'Crafting')
    GROUP BY
        wc.workshop_id
),

dwarf_days AS (
    SELECT
        wc.workshop_id,
        SUM(
            CASE WHEN da.end_date IS NULL THEN 
                (CURRENT_DATE - da.start_date) + 1
            ELSE 
                (da.end_date - da.start_date) + 1
            END
        ) AS dwarf_days_total
    FROM 
        DWARF_ASSIGNMENTS da
    JOIN 
        WORKSHOP_CRAFTSDWARVES wc ON da.dwarf_id = wc.dwarf_id
    WHERE 
        da.assignment_type = 'Workshop'
    GROUP BY
        wc.workshop_id
),

workshop_active_days AS (
    SELECT
        wc.workshop_id,
        COUNT(DISTINCT days.day) AS active_days_count,
        MIN(days.day) AS first_active_day
    FROM 
        DWARF_ASSIGNMENTS da
    JOIN 
        WORKSHOP_CRAFTSDWARVES wc ON da.dwarf_id = wc.dwarf_id
    JOIN 
        GENERATE_SERIES(
            DATE_TRUNC('day', da.start_date), 
            DATE_TRUNC('day', COALESCE(da.end_date, CURRENT_DATE)),
            INTERVAL '1 day'
        ) AS days(day) ON TRUE
    WHERE 
        da.assignment_type = 'Workshop'
    GROUP BY
        wc.workshop_id
)

SELECT 
    w_s.workshop_id,
    w_s.workshop_name,
    w_s.workshop_type,
    w_s.num_craftsdwarves,
    w_s.total_quantity_produced,
    w_s.total_production_value,
    
    ROUND(
        COALESCE(
            w_s.total_quantity_produced / NULLIF(d_d.dwarf_days_total, 0), 0
        ), 2) AS daily_production_rate,
    
    ROUND(
        COALESCE(
            w_s.total_quantity_produced / NULLIF(w_s.total_used_materials, 0), 0
        ), 2) AS material_conversion_ratio,
    
    ROUND(
        COALESCE(w_s.total_production_value / NULLIF(w_s.total_used_materials, 0), 0), 2
    ) AS value_per_material_unit,
    
    ROUND(
        100.0 * w_a_d.active_days_count / NULLIF((CURRENT_DATE - w_a_d.first_active_day) + 1, 0), 2
    ) AS workshop_utilization_percent,
    
    ROUND(w_s.avg_product_quality, 2) AS avg_product_quality,
    
    ROUND(ds.average_craftsdwarf_skill, 2) AS average_craftsdwarf_skill,
    ROUND(ds.skill_quality_correlation, 2) AS skill_quality_correlation,
    
    JSON_BUILD_OBJECT(
        'craftsdwarf_ids', (
            SELECT JSON_AGG(DISTINCT w_c.dwarf_id)
            FROM WORKSHOP_CRAFTSDWARVES w_c
            WHERE w_c.workshop_id = w_s.workshop_id
        ),
        'product_ids', (
            SELECT JSON_AGG(DISTINCT w_p.product_id)
            FROM WORKSHOP_PRODUCTS w_p
            WHERE w_p.workshop_id = w_s.workshop_id
        ),
        'material_ids', (
            SELECT JSON_AGG(DISTINCT w_m.material_id)
            FROM WORKSHOP_MATERIALS w_m
            WHERE w_m.workshop_id = w_s.workshop_id
        ),
        'project_ids', (
            SELECT JSON_AGG(DISTINCT p.project_id)
            FROM PROJECTS p
            WHERE p.workshop_id = w_s.workshop_id
        )
    ) AS related_entities
FROM 
    workshop_stats w_s
LEFT JOIN
    dwarf_days d_d ON d_d.workshop_id = w_s.workshop_id
LEFT JOIN
    workshop_active_days w_a_d ON w_a_d.workshop_id = w_s.workshop_id
LEFT JOIN
    dwarf_skills ds ON ds.workshop_id = w_s.workshop_id;
```