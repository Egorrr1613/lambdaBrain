``` 
WITH attack_stats AS (
    SELECT 
        COUNT(DISTINCT ca.attack_id) AS total_attacks,
        COUNT(DISTINCT ca.creature_id) AS unique_attackers,
        SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END) AS successful_defenses,
        ROUND((SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END)::DECIMAL / 
               COUNT(DISTINCT ca.attack_id)) * 100, 2) AS defense_success_rate
    FROM creature_attacks ca
),

current_threats AS (
    SELECT 
        c.creature_id,
        c.type AS creature_type,
        c.threat_level,
        MAX(cs.date) AS last_sighting_date,
        MIN(ct.distance_to_fortress) AS territory_proximity,
        c.estimated_population AS estimated_numbers,
        COUNT(DISTINCT ca.attack_id) AS attack_count
    FROM creatures c
    JOIN creature_sightings cs ON c.creature_id = cs.creature_id
    JOIN creature_territories ct ON c.creature_id = ct.creature_id
    LEFT JOIN creature_attacks ca ON c.creature_id = ca.creature_id
    WHERE c.active = true
    GROUP BY c.creature_id, c.type, c.threat_level, c.estimated_population
    HAVING MAX(cs.date) > CURRENT_DATE - INTERVAL '1 year'
),

vulnerability_analysis AS (
    SELECT 
        l.location_id AS zone_id,
        l.name AS zone_name,
        COUNT(DISTINCT ca.attack_id) AS historical_breaches,
        l.fortification_level,
        AVG(ca.military_response_time_minutes) AS military_response_time,
        ROUND(
            (COUNT(DISTINCT CASE WHEN ca.outcome = 'Defeat' THEN ca.attack_id END)::DECIMAL / 
             NULLIF(COUNT(DISTINCT ca.attack_id), 0)) * 
            (1 - (l.fortification_level::DECIMAL / 5)) *
            (COALESCE(AVG(ca.military_response_time_minutes), 60) / 60),
            2
        ) AS vulnerability_score,
        JSON_OBJECT(
            'structure_ids', (
                SELECT JSON_ARRAYAGG(ds.structure_id)
                FROM defense_structures ds
                WHERE ds.location_id = l.location_id
            ),
            'squad_ids', (
                SELECT JSON_ARRAYAGG(DISTINCT sm.squad_id)
                FROM squad_members sm
                JOIN military_stations ms ON sm.squad_id = ms.squad_id
                WHERE ms.location_id = l.location_id AND sm.exit_date IS NULL
            )
        ) AS defense_coverage
    FROM locations l
    LEFT JOIN creature_attacks ca ON l.location_id = ca.location_id
    GROUP BY l.location_id, l.name, l.fortification_level
),

defense_effectiveness AS (
    SELECT 
        ds.type AS defense_type,
        COUNT(DISTINCT ca.attack_id) AS total_engagements,
        SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END) AS successful_defenses,
        ROUND((SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END)::DECIMAL / 
               COUNT(DISTINCT ca.attack_id)) * 100, 2) AS effectiveness_rate,
        ROUND(AVG(ca.enemy_casualties), 1) AS avg_enemy_casualties,
        JSON_ARRAYAGG(DISTINCT ds.structure_id) AS structure_ids
    FROM defense_structures ds
    JOIN creature_attacks ca ON ds.structure_id = ANY(ca.defense_structures_used)
    GROUP BY ds.type
),

military_readiness AS (
    SELECT 
        ms.squad_id,
        s.name AS squad_name,
        COUNT(DISTINCT sm.dwarf_id) AS active_members,
        ROUND(AVG(ds.level), 1) AS avg_combat_skill,
        ROUND(
            (COUNT(DISTINCT sm.dwarf_id)::DECIMAL / 
             (SELECT COUNT(*) FROM squad_members sm2 WHERE sm2.squad_id = ms.squad_id)) * 0.3 +
            (AVG(ds.level) / 10) * 0.4 +
            (SELECT COUNT(DISTINCT sb.report_id) FROM squad_battles sb 
             WHERE sb.squad_id = ms.squad_id AND sb.outcome = 'Victory')::DECIMAL / 
             NULLIF((SELECT COUNT(DISTINCT sb2.report_id) FROM squad_battles sb2 
                    WHERE sb2.squad_id = ms.squad_id), 0) * 0.3,
            2
        ) AS readiness_score,
        ROUND(
            (SELECT AVG(sb.enemy_casualties) FROM squad_battles sb 
             WHERE sb.squad_id = ms.squad_id)::DECIMAL / 
             NULLIF((SELECT AVG(sb.casualties) FROM squad_battles sb 
                    WHERE sb.squad_id = ms.squad_id), 0),
            2
        ) AS combat_effectiveness,
        JSON_ARRAYAGG(
            JSON_OBJECT(
                'zone_id', ms.location_id,
                'response_time', mc.response_time_minutes
            )
        ) AS response_coverage
    FROM military_stations ms
    JOIN military_squads s ON ms.squad_id = s.squad_id
    JOIN squad_members sm ON s.squad_id = sm.squad_id AND sm.exit_date IS NULL
    JOIN dwarf_skills ds ON sm.dwarf_id = ds.dwarf_id
    JOIN skills sk ON ds.skill_id = sk.skill_id
    LEFT JOIN military_coverage_zones mc ON ms.squad_id = mc.squad_id AND ms.location_id = mc.zone_id
    WHERE sk.category IN ('Combat', 'Military')
    GROUP BY ms.squad_id, s.name
),

security_evolution AS (
    SELECT 
        EXTRACT(YEAR FROM ca.date) AS year,
        COUNT(DISTINCT ca.attack_id) AS total_attacks,
        SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END) AS successful_defenses,
        ROUND((SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END)::DECIMAL / 
               COUNT(DISTINCT ca.attack_id)) * 100, 2) AS defense_success_rate,
        SUM(ca.casualties) AS casualties,
        ROUND(
            ((SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END)::DECIMAL / 
              COUNT(DISTINCT ca.attack_id)) * 100) -
            LAG((SUM(CASE WHEN ca.outcome = 'Victory' THEN 1 ELSE 0 END)::DECIMAL / 
                 COUNT(DISTINCT ca.attack_id)) * 100) 
            OVER (ORDER BY EXTRACT(YEAR FROM ca.date)),
            2
        ) AS year_over_year_improvement
    FROM creature_attacks ca
    GROUP BY EXTRACT(YEAR FROM ca.date)
)

SELECT 
    JSON_OBJECT(
        'total_recorded_attacks', (SELECT total_attacks FROM attack_stats),
        'unique_attackers', (SELECT unique_attackers FROM attack_stats),
        'overall_defense_success_rate', (SELECT defense_success_rate FROM attack_stats),
        'security_analysis', JSON_OBJECT(
            'threat_assessment', JSON_OBJECT(
                'current_threat_level', CASE 
                    WHEN MAX(ct.threat_level) >= 4 THEN 'High'
                    WHEN MAX(ct.threat_level) >= 2 THEN 'Moderate' 
                    ELSE 'Low' 
                END,
                'active_threats', (
                    SELECT JSON_ARRAYAGG(
                        JSON_OBJECT(
                            'creature_type', ct.creature_type,
                            'threat_level', ct.threat_level,
                            'last_sighting_date', ct.last_sighting_date,
                            'territory_proximity', ct.territory_proximity,
                            'estimated_numbers', ct.estimated_numbers,
                            'creature_ids', (
                                SELECT JSON_ARRAYAGG(c2.creature_id)
                                FROM creatures c2 
                                WHERE c2.type = ct.creature_type AND c2.active = true
                            )
                        )
                    )
                    FROM current_threats ct
                    ORDER BY ct.threat_level DESC
                )
            ),
            'vulnerability_analysis', (
                SELECT JSON_ARRAYAGG(
                    JSON_OBJECT(
                        'zone_id', va.zone_id,
                        'zone_name', va.zone_name,
                        'vulnerability_score', va.vulnerability_score,
                        'historical_breaches', va.historical_breaches,
                        'fortification_level', va.fortification_level,
                        'military_response_time', va.military_response_time,
                        'defense_coverage', va.defense_coverage
                    )
                )
                FROM vulnerability_analysis va
                WHERE va.vulnerability_score > 0.5
                ORDER BY va.vulnerability_score DESC
            ),
            'defense_effectiveness', (
                SELECT JSON_ARRAYAGG(
                    JSON_OBJECT(
                        'defense_type', de.defense_type,
                        'effectiveness_rate', de.effectiveness_rate,
                        'avg_enemy_casualties', de.avg_enemy_casualties,
                        'structure_ids', de.structure_ids
                    )
                )
                FROM defense_effectiveness de
                WHERE de.total_engagements > 0
                ORDER BY de.effectiveness_rate DESC
            ),
            'military_readiness_assessment', (
                SELECT JSON_ARRAYAGG(
                    JSON_OBJECT(
                        'squad_id', mr.squad_id,
                        'squad_name', mr.squad_name,
                        'readiness_score', mr.readiness_score,
                        'active_members', mr.active_members,
                        'avg_combat_skill', mr.avg_combat_skill,
                        'combat_effectiveness', mr.combat_effectiveness,
                        'response_coverage', mr.response_coverage
                    )
                )
                FROM military_readiness mr
                ORDER BY mr.readiness_score DESC
            ),
            'security_evolution', (
                SELECT JSON_ARRAYAGG(
                    JSON_OBJECT(
                        'year', se.year,
                        'defense_success_rate', se.defense_success_rate,
                        'total_attacks', se.total_attacks,
                        'casualties', se.casualties,
                        'year_over_year_improvement', se.year_over_year_improvement
                    )
                )
                FROM security_evolution se
                ORDER BY se.year
            )
        )
    ) AS security_report
FROM current_threats ct
LIMIT 1;
```